<!-- If you are reading this, you are a real tinkerer! -->
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>myLightbox</title><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><style>body{font-family:Arial,sans-serif;margin:0;padding:0;background-color:#222831}main{max-width:600px;margin:auto;padding:20px}footer{background-color:#393e46;color:#fff;text-align:center;padding:10px}article{background-color:#393e46;margin-bottom:20px;padding:20px;padding-top:10px;border-radius:10px}h1,h2,h3{color:#ffd369}form{display:flex;flex-direction:column}input,select{padding:8px;border:none;border-radius:4px;box-sizing:border-box;background-color:#eee;margin:10px;max-width:100px;width:100%}i,label,p{color:#eee}button i,label i{color:#222831}#costumize_matrix button,#settings_article button{width:100%}#color_picker{display:block;margin:0 auto;margin-bottom:5%;min-height:50px;border:none;padding:5px;cursor:pointer;min-width:100%}#color_picker:hover{background-color:#eee}.slider{-webkit-appearance:none;appearance:none;width:100%;height:8px;border-radius:5px;background:#d3d3d3;outline:0;opacity:.7;-webkit-transition:.2s;transition:opacity .2s}.slider:hover{opacity:1}.slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;background:#ffd369;border-radius:50%;cursor:pointer}.slider::-moz-range-thumb{width:20px;height:20px;background:#000;border-radius:50%;cursor:pointer}#brightness_slider{margin:5%}.file-upload,button{border-style:solid;border-radius:4px;padding:12px;border-width:2px;margin:5px;text-decoration:none;text-align:center;font-size:16px;background-color:#ffd369;color:#000;cursor:pointer;transition:background-color .3s}.file-upload:hover,button:hover{background-color:#eee}#matrix_controls .material-icons{font-size:150%}#matrix_controls button{width:100%;display:flex;justify-content:space-between;align-items:center;font-size:120%}.separation-line{border-top:1px solid #eee;margin:20px 0}.align_right{margin-left:auto}.align_horisontaly{display:flex;align-items:center}.align_verticaly{display:flex;flex-direction:column;justify-content:center;align-items:center}.space_evenly{display:flex;flex-wrap:wrap;justify-content:space-evenly;align-items:center}.scrollable-container{overflow-x:auto;white-space:nowrap;max-width:100%}.full-width{width:100%}.sep_buttons button,label{display:flex;justify-content:space-between}#costumize_matrix section{padding:2%}#costumize_matrix section button{width:98%;margin-bottom:2%}#costumize_matrix section label{margin-bottom:2%}#settings_article section{display:flex;align-items:center;padding:1%}#settings_article section section{border-top:1px solid #eee;margin:0;width:100%}#settings_article section .material-icons{font-size:36px;margin-right:10%}#settings_article section input[type=number]{width:50%}#brightness_value_p{display:block;text-align:center}.circle{width:10vw;height:10vw;max-width:70px;max-height:70px;aspect-ratio:1;border-radius:50%;border-style:solid;background-color:#eee;cursor:pointer}.pixel{aspect-ratio:1/1;margin:1px;background-color:#000;border:1px solid #000}.display_pixels{width:100%;max-width:400px;display:grid;grid-template-columns:repeat(16,1fr);grid-template-rows:repeat(16,1fr);margin:auto;background-color:#eee;box-sizing:border-box;padding:2px}.image_section{margin:5%}#quick_colores{margin:2%}.green_hover:hover{background-color:#4caf50}.del_button{display:flex;justify-content:space-between;align-items:center;font-size:120%;text-align:center;border-style:none;background-color:red}.file-upload{background-color:#ffd369;display:flex;border-style:none;text-align:center}.file-upload button{width:auto}.file-upload .material-icons{margin-right:auto}#imageInput{display:none}@media screen and (max-width:600px){#pixelGrid{max-width:100%}}</style></head><body><main><article><h2>Preview</h2><div id="pixelGrid" class="display_pixels"></div></article><article id="matrix_controls"><section class="align_horisontaly"><button onclick="adjust_event_pos(-1)"><i class="material-icons">arrow_back</i>Previous</button><button onclick="adjust_event_pos(1)">Next<i class="material-icons">arrow_forward</i></button></section></article><article id="costumize_matrix"><h2>Costumize</h2><input type="color" id="color_picker"><section class="space_evenly" id="quick_colores"><div id="red_circle" class="circle" style="background-color:red" onclick='set_color_picker("#ff0000")'></div><div id="red_circle" class="circle" style="background-color:#0f0" onclick='set_color_picker("#00ff00")'></div><div id="red_circle" class="circle" style="background-color:#00f" onclick='set_color_picker("#0000ff")'></div><div id="red_circle" class="circle" style="background-color:#ff0" onclick='set_color_picker("#ffff00")'></div><div id="red_circle" class="circle" style="background-color:#fff" onclick='set_color_picker("#ffffff")'></div><div id="red_circle" class="circle" style="background-color:#000" onclick='set_color_picker("#000000")'></div></section><section class="align_horisontaly sep_buttons"><button type="button" onclick="convert_image_to_PPM(!0)"><i class="material-icons">undo</i>Revert</button><button onclick="fill_color()"><i class="material-icons">format_color_fill</i>Fill color</button></section><section class="sep_buttons"><button id="convert_and_send" class="green_hover" onclick="convert_div_and_send()"><i class="material-icons">upload</i>Upload image</button><label for="imageInput" class="file-upload"><i class="material-icons">folder</i>Choose image</label><input type="file" id="imageInput" accept=".jpg, .jpeg, .png" onchange="convert_image_to_PPM(!0)"><button type="button" onclick="get_image_names()"><i class="material-icons">image</i>View all images</button></section><div id="display_images" class="align_horisontaly scrollable-container"></div></article><article id="settings_article"><h2>Matrix settings</h2><section class="align_horisontaly"><i class="material-icons">location_on</i><section class="align_horisontaly"><label for="location">Location</label><div class="align_right align_horisontaly"><input type="tel" placeholder="Longitude" pattern="^-?\d+(\.\d+)?$" title="Enter a valid longitude" id="lon_input"> <input type="tel" placeholder="Latitude" pattern="^-?\d+(\.\d+)?$" title="Enter a valid latitude" id="lat_input"></div></section></section><section class="align_horisontaly"><i class="material-icons">device_thermostat</i><section class="align_horisontaly" style="width:100%"><label for="temp_unit" style="width:100%">Temp unit</label><select name="temp_unit" id="temp_select"><option value="metric">Metric</option><option value="imperial">Imperial</option><option value="kelvin">Kelvin</option></select></section></section><section class="align_horisontaly"><i class="material-icons">schedule</i><section class="align_horisontaly"><label for="widthInput">Time offset (hours)</label><input class="align_right" placeholder="Offset" type="number" id="time_offset" name="time_offset" min="-12" max="12" step="1" value=""></section></section><section class="slidecontainer"><section id="slider_and_icons" class="space_evenly"><i class="material-icons" style="margin:0">brightness_low</i><input type="range" min="1" max="100" value="100" class="slider" id="brightness_slider"><i class="material-icons" style="margin:0">brightness_high</i></section></section><p id="brightness_value_p">Brightness:<span id="brightness_value"></span>%</p><div id="current_settings_output" class="align_verticaly"></div><button onclick="request_settings_reset()">Reset to default settings</button><button onclick="request_refresh_weather()">Refresh weather data</button><button onclick="display_current_settings()">Current settings</button><button class="green_hover" type="button" onclick="send_settings()">Upload changes</button></article></main><footer><p>&copy; 2024 lightbox-Torbj√∏rn L. Birkeland</p></footer><script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><script>let slider=document.getElementById("brightness_slider"),output=document.getElementById("brightness_value"),colorPicker=document.getElementById("color_picker");const pixelContainer=document.getElementById("pixelGrid");let isMouseDown=!1;output.innerHTML=slider.value;const NUM_PIXELS=256,SERVER_URL=window.location.origin;let pixelColors=[];function set_color_picker(e){colorPicker.value=e}function request_settings_reset(){window.confirm("Are you sure you want to reset the settings?")?get_request(SERVER_URL+"/settings?type=revert"):console.log("Settings reset cancelled.")}function request_refresh_weather(){get_request(SERVER_URL+"/refresh_weather")}function send_settings(){let e=document.getElementById("brightness_slider").value,t=document.getElementById("lon_input").value,n=document.getElementById("lat_input").value,o=document.getElementById("temp_select").value,i=document.getElementById("time_offset").value;console.log("val: "+i);let l=SERVER_URL+"/settings?type=change&brightness="+e+"&units="+o;""!=t&&(l+="&lon="+t),""!=n&&(l+="&lat="+n),""!=i&&(l+="&timezone_offset="+3600*i),get_request(l)}function get_settings_data(){return get_request(SERVER_URL+"/settings?type=inf","json")}function adjust_event_pos(e){get_request(SERVER_URL+"/event_pos?increment="+e)}function display_current_settings(){let e=document.getElementById("current_settings_output");get_settings_data().then(t=>{console.log(t.location),e.innerHTML=`<h3 class="separation-line" style="padding-top: 5%;">Current settings</h3> <p ><strong>Location:</strong> lon: ${t.location.lon} lat: ${t.location.lat}</p> <p><strong>Temp unit:</strong> ${t.units}</p> <p><strong>Timezone offset:</strong> ${t.location.timezone_offset/3600} hour(s)</p>`})}function get_image_names(){let e=SERVER_URL+"/images?type=inf";console.log("Fetching images from:",e),get_request(e).then(e=>{display_image_names(e.split("\n"))})}function get_image_data(e){get_request(SERVER_URL+"/images?type=data&filename="+e).then(e=>{e.split("\n"),display_ppm_content(e,16,16)})}function del_file(e){let t=SERVER_URL+"/images?type=del&filename="+e;console.log("Fetching images from:",t),get_request(t).then(e=>{console.log("Success, file deleted"+filenames_array)}),get_image_names()}function display_image_names(e){let t=document.getElementById("display_images");if(t.innerHTML="",1===e.length&&""===e[0])t.innerHTML+="<p>No images saved on led matrix</p>";else for(let n=0;n<e.length;n++)t.innerHTML+=`<section class="align_verticaly image_section"><button type="button" onclick="get_image_data('${e[n]}')">${e[n]}</button><button type="button" class="del_button" onclick="del_file('${e[n]}')"><i class="material-icons">delete</i>Delete image</button></section>`}function fill_color(){let e=$("#color_picker").val();create_pixel_grid(e)}function create_pixel_grid(e){let t=document.getElementById("pixelGrid");t.innerHTML="";for(let n=0;n<256;n++)t.innerHTML+=`<div id='pixel-${n}' class='pixel' style="background-color: ${e}"></div>`}function updatePixels(){pixelColors=[];for(let e=0;e<256;e++){let t=getComputedStyle(document.getElementById(`pixel-${e}`)).backgroundColor,n=t.match(/\d+/g);n&&3===n.length?pixelColors.push([parseInt(n[0]),parseInt(n[1]),parseInt(n[2])]):pixelColors.push([0,0,0])}}function generatePPM(e){let t=e.getContext("2d"),n=t.getImageData(0,0,e.width,e.height).data,o=[];o.push(`P3
${e.width} ${e.height}
255`);for(let i=0;i<n.length;i+=4){let l=n[i],s=n[i+1],r=n[i+2];o.push(`${l} ${s} ${r}`)}return o.join("\n")}function convertToPPM(){let e=[];e.push(`------WebKitFormBoundary1234567891234567\r
Content-Disposition: form-data; name="file"; filename="paintedPPM.ppm"\r
Content-Type: image/x-portable-pixmap\r
\r
P3
16 16
255`);for(let t=0;t<256;t++){let[n,o,i]=pixelColors[t];e.push(`${n} ${o} ${i}`)}e.push("\r------WebKitFormBoundary1234567891234567--\r\n");let l=e.join("\n");return l}function display_ppm_content(e,t,n,o="pixelGrid"){let i=document.getElementById(o);i.innerHTML="";let l=e.trim().split("\n").slice(3),s=l.map(e=>e.split(" ").map(Number)),r=0;for(let a=0;a<n;a++)for(let u=0;u<t;u++){let c=document.createElement("div");c.classList.add("pixel"),c.id="pixel-"+r;let[p,g,d]=s[a*t+u];c.style.backgroundColor=`rgb(${p}, ${g}, ${d})`,i.appendChild(c),r++}}function convert_image_to_PPM(e,t=!1){let n=document.getElementById("imageInput"),o=n.files[0];if(!o){alert("Please choose an image file.");return}let i=new FileReader;i.onload=function(n){let i=new Image;i.onload=function(){let n=document.createElement("canvas"),l=n.getContext("2d");n.width=16,n.height=16,l.drawImage(i,0,0,16,16);let s=generatePPM(n);if(!0==e&&display_ppm_content(s,16,16),!0==t){let r=new Blob([s],{type:"image/x-portable-pixmap"}),a=o.name,u=a.replace(/\.[^/.]+$/,"")+".ppm",c=new FormData;c.append("file",r,u),upload_file(c)}},i.src=n.target.result},i.readAsDataURL(o)}function upload_file(e){post_request(SERVER_URL+"/file?type=upload_image",e)}function convert_div_and_send(){updatePixels();upload_file(convertToPPM()),console.log("done")}function get_request(e,t){return fetch(e,{method:"GET"}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return"json"===t?(console.log("json encoding"),e.json()):(console.log("text encoding"),e.text())}).catch(e=>{console.error("There was a problem with the fetch operation:",e)})}function post_request(e,t){fetch(e,{method:"POST",headers:{"Content-Type":"multipart/form-data"},body:t}).then(e=>{if(e.ok)console.log("POST request succeeded with response:",e),alert("File uploaded successfully!");else if(507===e.status)console.warn("507 (Insufficient Storage)"),alert("Too many files are stored on Matrix, the limit is 10 images. Please delete an image to download");else throw Error("Network response was not ok");return e.text()}).catch(e=>{throw console.error("There was a problem with the POST request:",e),alert("File upload might have failed. (Maximum stored images is 10)"),e})}$(document).ready(function(){create_pixel_grid("black")}),slider.oninput=function(){output.innerHTML=this.value},$(document).on("click",".pixel",function(){let e=$("#color_picker").val();$(this).css("background-color",e)}),$(document).on("mousedown",".pixel",function(){isMouseDown=!0}),$(document).on("mouseup",function(){isMouseDown=!1}),$(document).on("mouseover",".pixel",function(){if(isMouseDown){let e=$("#color_picker").val();$(this).css("background-color",e)}}),pixelContainer.addEventListener("touchstart",function(e){isMouseDown=!0}),pixelContainer.addEventListener("touchend",function(){isMouseDown=!1}),pixelContainer.addEventListener("touchmove",function(e){if(e.preventDefault(),isMouseDown){let t=$("#color_picker").val(),n=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);$(n).hasClass("pixel")&&$(n).css("background-color",t)}});</script></body></html>